# 分布式id生成

> 目前开源的主要有美团的 leaf 和 twitter 的雪花算法（snowflake）

## 雪花算法

雪花算法核心组成：

- 1 位 sign 标识位
- 41 位时间戳
- 10 位 workId（数据中心+工作机器）
- 12 位自增序列

41 位时间戳可以标识（1<<41)/(1000\*3600\*24\*365)=69.73057000101471 年的时间，一般系统很难用到这么久，这么长时间足够用了。10 位机器可以分别标识 1024 台机器，如果有多个数据中心（IDC)，还可以自己划分指定位数给 IDC，剩下的位数分给机器就行了。12 个自增序列可以表示 2^12 个 ID,理论上 snowflake 的 qps 能达到 409.6w/s，这种方式可以保证任意 IDC 的任意一台机器在任意毫秒内生成的 ID 都是不同的。

优点：

- 毫秒数在高位，自增序列在低位，整个 ID 都是趋势递增的
- 不依赖数据库等第三方系统，以服务的方式部署，稳定性高，生成的 ID 性能也很高
- 可以根据业务特性分配位数，灵活性高。
  缺点：

* 强依赖机器时间，如果机器上时钟回拨，则会导致发号重复或者服务处于不可用状态

::: warning 时钟回拨
时钟回拨可能是系统原因修改系统时间到系统当前时间之前，还有一种原因是闰秒会导致时间回拨。
闰秒：
是对协调时间时（UTC）的周期性 1 秒钟调整，目的是让系统时间接近平均太阳时。为什么平均太阳时会改变？那是因为地球自转速度会因为气候和地理活动发生变化。。当世界时与原子时之间相差超过+-0.9 秒时，就会把协调世界时间向前拨 1 秒或者向后拨 1 秒

UTC 闰秒也是不规律的，闰秒的调整一般是在一年的六月份或者十二月份，最近一次调整是（2016 年 12 月 31 日 23 时 59 分 59 秒之后是 2016 年 12 月 31 日 23 时 59 分 60 秒，中国是东八区，时间调整为 2017 年 1 月 1 日 07 时 59 分 60 秒）
UTC 闰秒调整方式 会在 xxxx 年 xx 月 xx 日 xx 时 59 分 59 秒 之后新增 xxxx 年 xx 月 xx 日 xx 时 59 分 60 秒
目前 java 中获取时间当日期是 2016-12-31 23:59:60 对应的时间戳为 1514736000000，017-01-01 00:00:00 对应的时间戳也是 1514736000000，两者是一样的，这个时候就产生了时间戳回拨的情况。
:::

## 美团雪花算法

- 美团的雪花算法整体上结构依旧保持原雪花算法的结构，只是在生成 workId 的时候引入了 zookeeper，弱依赖 zookeeper。
- 启动服务的时候会在 zookeeper 检查是否已经注册过 `/snowflake/com.sankuai.leaf.opensource.test/forever` 节点
  - 如果没有存在持久节点，则创建持久顺序节点并上传数据(包含节点 ip，端口 zk 端口号，时间戳),并且创建线程定时上报本机时间（默认 3s 上报一次）；
  - 如果已经存在持久节点 - 判断该机器是否在 zookeeper 注册过，如果注册过，则从 zookeeper 的顺序节点名称中获取自己的 workerId（利用顺序节点特性），并校验改节点的时间不能小于最后一次上报时间，否则抛出异常；然后创建线程定时上报本机时间（默认 3s 上报一次），更新本地缓存的 workId；当下次 zookeeper 出问题的时候可以从本地缓存的文件中获取 workId - 如果没有注册过，则表明是新的机器，创建持久节点 ,不用 check 时间，然后创建线程上报本机时间，缓存 workId
- 美团雪花算法生成策略和雪花算法是一致的
  - 为了解决时间回拨，在生成 id 之前会校验一下上次生成 id 的时间和当前系统时间差是否小于 5ms，如果小于 5ms 会等待时间差的 2 倍时间，然后再次校验当前系统时间是否小于最后一次生成 id 的时间，如果还是小于则抛出异常。
  - 如果当前系统时间等于最后一次生成 id 的时间则自增序列 sequence = （sequence+1)&(~(-1<<12))；如果 sequence=0，则表示序列已经达到了最大值，然后会循环等待当前系统时间>上次生成 id 的时间，然后 sequence 会初始一个 100 以内的随机数作为 sequence 这个 ms 内的初始值
  - 否则，会随机生成一个 100 以内的随机数作为新的 ms 内的初始值
  - 生成 id
    - 前 41 位为时间戳
      - 这里美团略有改动生成的 id 时间戳有减去一个初始时间戳，可能是为了生成 id 的安全考虑
    - 中间 10 位为 workId
      - 美团的 workId 利用 zookeeper 的顺序节点的特性获取的
    - 最后 12 位为递增序列（sequence）

## 数据库生成策略

## redis 生成策略
