# 使用 redis 生成数据库 id 重复原因

产生重复数据库 id 原因：

生产 id 方法：
首先根据时间/1000+业务线名字 作为 key 值存储自增数
系统时间/1000 转为二进制作为前 32 位，

前 32 位：系统时间/1000 转二进制
中间 16 位： 8192 计算哈希值 %8192 = 5074 (1001111010010)
然后自增 sid 转成二进制作为中间 16 位，最后 16 位留做自增空间
就是说如果同 1s 内生成超过 2^16 次个就必然会有重复的（或者 2^19,可以复用固定值的二进制的最后 3 位)

a1.调用方法 b1（用表名 A 作为业务线名字）生成 A 表 id 系统时间是 1583940656 2.其他地方调用方法 b2（用表明 B 作为业务线名字）生成 A 表 id 系统时间是 1583940656095

a1 中，这个时候生成 id 方法 redis 自增 key 值为 1583940656_A 自增值为 1 ，
产生 id 为 1583940656094（1011110011010010000010000110000） 固定值（1001111010010 000） 0000000000000001
101111001101001000001000011000000010011110100100000000000000001
即：6802973316657315841
a2 中，生成 id 方法，redis 自增 key 值为 1583940656_B 自增值为 1，（因为这个和 a1 中的 key 值不同，索引不会自增到 2），
产生 id 为 1583940656（1011110011010010000010000110000） 固定值（1001111010010 000） 0000000000000001
101111001101001000001000011000000010011110100100000000000000001
即：6802973316657315841

两个生成 id 是相同的，插入同一个表中，比如 1 先插入，那么到 2 的时候必定会出现 id 重复报错

BillSubDetailDaoImpl.java:39
BillCoreServiceImpl.java:427
ConfirmRentBillListener.java:213

uniqueNo 重复原因

生成 uniqueNo 是通过日期+业务类型+自增 id

A，B 同时生成 uniqueNo
A 刚进入方法获取系统时间是 1583992443970
获取自增 id 方法中重新获取一次系统时间是 1583992443970
根据系统时间作为 key 的一部分，自增值为 1
B 刚进入方法获取系统时间是 1583992443970
获取自增 id 方法中重新获取一次系统时间是 1583992443971
根据系统时间作为 key 的一部分，自增值为 1

这个时候返回主方法拼接自增 id 的时候
A: 1583992443970 + 00001
B: 1583992443970 + 00001

产生重复 uniqueNo

保存车辆推送违章费失败
订单号 188313 调用 addBillDetail 方法异常
获取锁失败需要重新消费
MQ--租金账单生成失败
外部支付失败
